<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>使用Visual Studio Code搭建多用户远程IDE | bits-pieces</title><link rel=icon href=/bits-pieces/favicon/favicon-32x32.png type=image/x-icon><link rel=stylesheet href=/bits-pieces/main.min.css media=screen><link rel=stylesheet href=/bits-pieces/custom.css media=screen><link rel=alternate type=application/rss+xml href=https://l10178.github.io/bits-pieces/devops/cdr/index.xml title=bits-pieces></head><body><div class=wrapper><input type=checkbox class=hidden id=menu-control><header class=gdoc-header><div class="container flex align-center justify-between"><label for=menu-control class=gdoc-nav__control><svg class="icon menu"><use xlink:href="#menu"/></svg><svg class="icon arrow-back"><use xlink:href="#arrow_back"/></svg></label><a class=gdoc-header__link href=https://l10178.github.io/bits-pieces/><span class="gdoc-brand flex align-center"><img class=gdoc-brand__img src=/bits-pieces/images/logos/logo.png alt=bits-pieces width=38 height=38>
bits-pieces</span></a></div></header><main class="container flex flex-even"><aside class=gdoc-nav><nav><div class=gdoc-search><svg class="icon search"><use xlink:href="#search"/></svg><input type=text id=gdoc-search-input class=gdoc-search__input placeholder=Search... aria-label=Search maxlength=64><div class="gdoc-search__spinner spinner hidden"></div><ul id=gdoc-search-results class=gdoc-search__list></ul></div><section class=gdoc-nav--main><h2>Navigation</h2><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/devops/ class=gdoc-nav__entry>DevOps</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/devops/mysql5.7to8.0/ class=gdoc-nav__entry>MySQL5.7升级至8.0</a></span></li><li><span class=flex><a href=/bits-pieces/devops/mysql-large-import/ class=gdoc-nav__entry>MySQL大文件导入优化</a></span></li><li><span class=flex><a href=/bits-pieces/devops/nexus/ class=gdoc-nav__entry>Nexus3 批量导入</a></span></li><li><span class=flex><a href=/bits-pieces/devops/superset/ class=gdoc-nav__entry>Superset 对接 ClickHouse</a></span></li><li><span class=flex><a href=/bits-pieces/devops/cdr/ class="gdoc-nav__entry is-active">使用Visual Studio Code搭建多用户远程IDE</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/java/ class=gdoc-nav__entry>Java</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/java/jvm/ class=gdoc-nav__entry>Java进程内存分析</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring-boot-micrometer/ class=gdoc-nav__entry>Spring Boot 使用 Micrometer 集成 Prometheus 监控</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring-start-site/ class=gdoc-nav__entry>Spring Start脚手架快速入门</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring-boot/ class=gdoc-nav__entry>从 Spring 到 Spring Boot</a></span></li></ul></li><li><span class=flex>Kubernetes</span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/kubernetes/envoy/ class=gdoc-nav__entry>Envoy生产配置最佳实践</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/tldr/ class=gdoc-nav__entry>TL;DR</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/cka/ class=gdoc-nav__entry>备考 CKA 过程，CKA 真题</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/pid/ class=gdoc-nav__entry>容器进程数限制</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/linux/ class=gdoc-nav__entry>Linux</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/linux/regular-expressions/ class=gdoc-nav__entry>Regular Expressions</a></span></li><li><span class=flex><a href=/bits-pieces/linux/git/ class=gdoc-nav__entry>Git常用配置</a></span></li><li><span class=flex><a href=/bits-pieces/linux/history/ class=gdoc-nav__entry>History入门</a></span></li><li><span class=flex><a href=/bits-pieces/linux/pngquant/ class=gdoc-nav__entry>PNG图片批量压缩</a></span></li><li><span class=flex><a href=/bits-pieces/linux/shell-coding/ class=gdoc-nav__entry>Shell 编程实用句式</a></span></li><li><span class=flex><a href=/bits-pieces/linux/tcpdump/ class=gdoc-nav__entry>tcpdump</a></span></li><li><span class=flex><a href=/bits-pieces/linux/transaction/ class=gdoc-nav__entry>数据库事务控制</a></span></li><li><span class=flex><a href=/bits-pieces/linux/tar.gz/ class=gdoc-nav__entry>文件压缩解压</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/windows/ class=gdoc-nav__entry>Windows</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/windows/takeown/ class=gdoc-nav__entry>Windows提权 + 设置环境变量</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/knives/ class=gdoc-nav__entry>瑞士军刀</a></span></li></ul></section><section class=gdoc-nav--more><h2>More</h2><ul class=gdoc-nav__list><li><span class=flex><svg class="icon download"><use xlink:href="#download"/></svg><a href=https://github.com/l10178/bits-pieces/releases class=gdoc-nav__entry>Releases</a></span></li><li><span class=flex><svg class="icon github"><use xlink:href="#github"/></svg><a href=https://github.com/l10178/bits-pieces class=gdoc-nav__entry>View Source</a></span></li></ul></section></nav></aside><div class=gdoc-page><div class="gdoc-page__header flex flex-wrap justify-between" itemscope itemtype=https://schema.org/Breadcrumb><span></span><span><svg class="icon code"><use xlink:href="#code"/></svg><a href=https://github.com/l10178/bits-pieces/edit/main/content/devops/cdr/_index.md>Edit this page</a></span></div><article class=gdoc-markdown><h1>使用Visual Studio Code搭建多用户远程IDE</h1><p>Securing Visual Studio <a href=https://github.com/cdr/code-server>code-server</a>, support multi-user.</p><p>为 <a href=https://github.com/cdr/code-server>code-server</a>（VS Code Web 版） 增加外部认证，并支持多用户，不同用户的 code-server 实例完全隔离。</p><p>主要为了解决问题：</p><ol><li><p>code-server 本身支持配置文件形式的用户名密码认证（截止目前，以后也许会改进）。所以引入了外部认证系统，Google、GitHub、 okta、CAS、Keycloak 等理论上都是支持的。</p></li><li><p>code-server 默认没有数据隔离，所以又加了一层 proxy，为每个用户创建一个（或多个）code-server 实例，以实现用户间的数据隔离。</p></li><li><p>使用开源 Auth Proxy，自己不需要实现复杂的登录流程了，比如 <code>code flow with pkce</code> 对大部分人来说读懂这个协议都很困难。</p></li></ol><div class=gdoc-page__anchorwrap><h2 id=使用组件>使用组件<a data-clipboard-text=https://l10178.github.io/bits-pieces/devops/cdr/#使用组件 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 使用组件" href=#使用组件><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><ul><li><p><a href=https://github.com/keycloak/keycloak>keycloak</a></p><p>Redhat 开源 IAM 系统，提供用户、组织服务，提供标准 OIDC。</p></li><li><p><a href=https://github.com/oauth2-proxy/oauth2-proxy>oauth2-proxy</a></p><p>认证代理，配合 keycloak 提供完整 OAuth2 Code Flow 认证流程。也可以试试 <a href=https://github.com/pomerium/pomerium>pomerium</a>，看样子也不错。</p></li></ul><p>架构图如下。</p><p><img src="https://www.plantuml.com/plantuml/proxy?cache=no&amp;src=https://raw.githubusercontent.com/l10178/architecture-diagram/main/code-server-auth-proxy/code-server-auth-proxy.puml" alt=code-server-auth-proxy></p><div class=gdoc-page__anchorwrap><h2 id=核心逻辑>核心逻辑<a data-clipboard-text=https://l10178.github.io/bits-pieces/devops/cdr/#核心逻辑 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 核心逻辑" href=#核心逻辑><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>架构图简单解读，所有过程官方文档都有详细说明，都是配置，以官方配置为准。</p><ol><li><p>keycloak 创建 client，使用 OIDC 协议，作为 oauth2-proxy 的 provider。</p></li><li><p>ingress(nginx) 使用 auth_request 指令拦截所有请求，从 oauth2-proxy 进行代理认证，配置可参考 <a href=https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/overview/#configuring-for-use-with-the-nginx-auth_request-directive>oauth2-proxy auth_request</a> 指导。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>nginx.ingress.kubernetes.io/auth-signin</span><span class=p>:</span><span class=w> </span><span class=l>https://$host/oauth2/start?rd=$escaped_request_uri</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nginx.ingress.kubernetes.io/auth-url</span><span class=p>:</span><span class=w> </span><span class=l>https://$host/oauth2/auth</span><span class=w>
</span></span></span></code></pre></div></li><li><p>认证通过后，将用户名/ID 作为标识，通过 Http Header (举例如 X-Forwarded-Preferred-Username) 传入 upstream。</p></li><li><p>gateway(nginx) 从 Header 中获取用户标识，代理到此用户对应的 code-server 实例。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl>  <span class=k>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>……</span>
</span></span><span class=line><span class=cl>    <span class=s>proxy_pass</span> <span class=s>http://code-server-</span><span class=nv>$http_x_forwarded_for_preferred_username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></div></li><li><p>code-server 各个实例部署时，以免认证方式部署。</p></li><li><p>每个 code-server 实例挂载不同的存储，实现完全隔离。</p></li></ol></article><div class="gdoc-page__footer flex flex-wrap justify-between"></div></div></main><footer class=gdoc-footer><div class="container flex flex-wrap"><span class=gdoc-footer__item>Copyright © 2020-2022 <a href=https://www.nxest.com class=gdoc-footer__link>nxest.com</a>.</span></div></footer></div><script defer src=/bits-pieces/js/en.search.min.js></script>
<script defer src=/bits-pieces/js/clipboard.min.js></script>
<script>document.addEventListener("DOMContentLoaded",function(){var t=new ClipboardJS(".clip")})</script></body></html>