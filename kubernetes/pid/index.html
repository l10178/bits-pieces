<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>容器进程数限制 | bits-pieces</title><link rel=icon href=/bits-pieces/favicon/favicon-32x32.png type=image/x-icon><link rel=stylesheet href=/bits-pieces/main.min.css media=screen><link rel=stylesheet href=/bits-pieces/custom.css media=screen></head><body><div class=wrapper><input type=checkbox class=hidden id=menu-control><header class=gdoc-header><div class="container flex align-center justify-between"><label for=menu-control class=gdoc-nav__control><svg class="icon menu"><use xlink:href="#menu"/></svg><svg class="icon arrow-back"><use xlink:href="#arrow_back"/></svg></label><a class=gdoc-header__link href=https://l10178.github.io/bits-pieces/><span class="gdoc-brand flex align-center"><img class=gdoc-brand__img src=/bits-pieces/images/logos/logo.png alt=bits-pieces width=38 height=38>
bits-pieces</span></a></div></header><main class="container flex flex-even"><aside class=gdoc-nav><nav><div class=gdoc-search><svg class="icon search"><use xlink:href="#search"/></svg><input type=text id=gdoc-search-input class=gdoc-search__input placeholder=Search... aria-label=Search maxlength=64><div class="gdoc-search__spinner spinner hidden"></div><ul id=gdoc-search-results class=gdoc-search__list></ul></div><section class=gdoc-nav--main><h2>Navigation</h2><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/devops/ class=gdoc-nav__entry>DevOps</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/devops/mysql5.7to8.0/ class=gdoc-nav__entry>MySQL5.7升级至8.0</a></span></li><li><span class=flex><a href=/bits-pieces/devops/mysql-large-import/ class=gdoc-nav__entry>MySQL大文件导入优化</a></span></li><li><span class=flex><a href=/bits-pieces/devops/nexus/ class=gdoc-nav__entry>Nexus3 批量导入</a></span></li><li><span class=flex><a href=/bits-pieces/devops/superset/ class=gdoc-nav__entry>Superset 对接 ClickHouse</a></span></li><li><span class=flex><a href=/bits-pieces/devops/cdr/ class=gdoc-nav__entry>使用Visual Studio Code搭建多用户远程IDE</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/java/ class=gdoc-nav__entry>Java</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/java/jvm/ class=gdoc-nav__entry>Java进程内存分析</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring-boot-micrometer/ class=gdoc-nav__entry>Spring Boot 使用 Micrometer 集成 Prometheus 监控</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring-start-site/ class=gdoc-nav__entry>Spring Start脚手架快速入门</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring-boot/ class=gdoc-nav__entry>从Spring到Spring Boot</a></span></li></ul></li><li><span class=flex>Kubernetes</span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/kubernetes/envoy/ class=gdoc-nav__entry>Envoy生产配置最佳实践</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/tldr/ class=gdoc-nav__entry>TL;DR</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/cka/ class=gdoc-nav__entry>备考 CKA 过程，CKA 真题</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/pid/ class="gdoc-nav__entry is-active">容器进程数限制</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/linux/ class=gdoc-nav__entry>Linux</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/linux/regular-expressions/ class=gdoc-nav__entry>Regular Expressions</a></span></li><li><span class=flex><a href=/bits-pieces/linux/git/ class=gdoc-nav__entry>Git常用配置</a></span></li><li><span class=flex><a href=/bits-pieces/linux/history/ class=gdoc-nav__entry>History入门</a></span></li><li><span class=flex><a href=/bits-pieces/linux/pngquant/ class=gdoc-nav__entry>PNG图片批量压缩</a></span></li><li><span class=flex><a href=/bits-pieces/linux/shell-coding/ class=gdoc-nav__entry>Shell 编程实用句式</a></span></li><li><span class=flex><a href=/bits-pieces/linux/tcpdump/ class=gdoc-nav__entry>tcpdump</a></span></li><li><span class=flex><a href=/bits-pieces/linux/transaction/ class=gdoc-nav__entry>数据库事务控制</a></span></li><li><span class=flex><a href=/bits-pieces/linux/tar.gz/ class=gdoc-nav__entry>文件压缩解压</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/windows/ class=gdoc-nav__entry>Windows</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/windows/takeown/ class=gdoc-nav__entry>Windows提权 + 设置环境变量</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/knives/ class=gdoc-nav__entry>瑞士军刀</a></span></li></ul></section><section class=gdoc-nav--more><h2>More</h2><ul class=gdoc-nav__list><li><span class=flex><svg class="icon download"><use xlink:href="#download"/></svg><a href=https://github.com/l10178/bits-pieces/releases class=gdoc-nav__entry>Releases</a></span></li><li><span class=flex><svg class="icon github"><use xlink:href="#github"/></svg><a href=https://github.com/l10178/bits-pieces class=gdoc-nav__entry>View Source</a></span></li></ul></section></nav></aside><div class=gdoc-page><div class="gdoc-page__header flex flex-wrap justify-between" itemscope itemtype=https://schema.org/Breadcrumb><span></span><span><svg class="icon code"><use xlink:href="#code"/></svg><a href=https://github.com/l10178/bits-pieces/edit/main/content/kubernetes/pid.md>Edit this page</a></span></div><article class=gdoc-markdown><h1>容器进程数限制</h1><p>问题描述：</p><p>一个 Java 应用跑在 K8S 容器内，Pod 内只有 Java 这一个进程。应用跑了一段时间后，开始出现以下错误。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Exception in thread &#34;slow-fetch-15&#34; java.lang.OutOfMemoryError: unable to create new native thread
</span></span></span><span class=line><span class=cl><span class=go>428 	at java.lang.Thread.start0(Native Method)
</span></span></span><span class=line><span class=cl><span class=go>429 	at java.lang.Thread.start(Thread.java:719)
</span></span></span><span class=line><span class=cl><span class=go>430 	at java.util.concurrent.ThreadPoolExecutor.addWorker(ThreadPoolExecutor.java:957)
</span></span></span><span class=line><span class=cl><span class=go>431 	at java.util.concurrent.ThreadPoolExecutor.processWorkerExit(ThreadPoolExecutor.java:1025)
</span></span></span><span class=line><span class=cl><span class=go>432 	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1167)
</span></span></span><span class=line><span class=cl><span class=go>433 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
</span></span></span></code></pre></div><p>进入 Pod 内，尝试执行任何操作，又会出现 <code>unable to start container process</code> 错误。</p><p>一开始怀疑是内存不足，调大了内存，同时也缩小了 Java 的 <code>xss</code>， 都不起作用。</p><p>真实原因： K8S 容器限制了 PID 数，无法创建新的线程，在 Pod 内 <code>cat /sys/fs/cgroup/pids/pids.max</code> 发现是 1024。</p><p>关于 K8S pod pid limit， 可参考此资料: <a href=https://kubernetes.io/zh-cn/docs/concepts/policy/pid-limiting/>https://kubernetes.io/zh-cn/docs/concepts/policy/pid-limiting/</a>.</p><p>但是，PID 为什么会超呢，Pod 内只有一个 Java 进程，PID 数不应该是 1 吗，这个 PID 限制为什么影响了<code>线程</code>。</p><p>简单来讲，在 Linux 中线程其实是通过轻量级进程实现的，也就是 LWP(light weight process)，因此在 Linux 中每个线程都是一个进程，都拥有一个 PID，换句话说，操作系统原理中的线程，对应的其实是 Linux 中的进程(即 LWP)，因此 Linux 内核中的 PID 对应的其实是原理中的 TID。</p><p>在 Pod 内通过 <code>top -p pid -H</code> 查看，可以看到第一列每个线程都有一个 PID。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
</span></span></span><span class=line><span class=cl><span class=go>101 root      20   0 8622220   5.1g  15640 S  0.3  8.1   0:16.29 VM Thread
</span></span></span><span class=line><span class=cl><span class=go>112 root      20   0 8622220   5.1g  15640 S  0.3  8.1   0:46.13 C2 CompilerThre
</span></span></span><span class=line><span class=cl><span class=go>113 root      20   0 8622220   5.1g  15640 S  0.3  8.1   0:39.62 C1 CompilerThre
</span></span></span><span class=line><span class=cl><span class=go>846 root      20   0 8622220   5.1g  15640 S  0.3  8.1   0:00.64 NettyClientSele
</span></span></span><span class=line><span class=cl><span class=go>850 root      20   0 8622220   5.1g  15640 S  0.3  8.1   0:00.54 NettyClientWork
</span></span></span><span class=line><span class=cl><span class=go>  1 root      20   0 8622220   5.1g  15640 S  0.0  8.1   0:00.27 java
</span></span></span><span class=line><span class=cl><span class=go>  89 root      20   0 8622220   5.1g  15640 S  0.0  8.1   0:00.99 java
</span></span></span><span class=line><span class=cl><span class=go>  90 root      20   0 8622220   5.1g  15640 S  0.0  8.1   0:03.29 java
</span></span></span><span class=line><span class=cl><span class=go>  91 root      20   0 8622220   5.1g  15640 S  0.0  8.1   0:03.27 java
</span></span></span><span class=line><span class=cl><span class=go>  92 root      20   0 8622220   5.1g  15640 S  0.0  8.1   0:03.26 java
</span></span></span><span class=line><span class=cl><span class=go>  93 root      20   0 8622220   5.1g  15640 S  0.0  8.1   0:03.30 java
</span></span></span><span class=line><span class=cl><span class=go>  94 root      20   0 8622220   5.1g  15640 S  0.0  8.1   0:01.43 java
</span></span></span><span class=line><span class=cl><span class=go>  95 root      20   0 8622220   5.1g  15640 S  0.0  8.1   0:00.11 java
</span></span></span><span class=line><span class=cl><span class=go>  96 root      20   0 8622220   5.1g  15640 S  0.0  8.1   0:00.12 java
</span></span></span><span class=line><span class=cl><span class=go>  97 root      20   0 8622220   5.1g  15640 S  0.0  8.1   0:00.16 java
</span></span></span><span class=line><span class=cl><span class=go>  98 root      20   0 8622220   5.1g  15640 S  0.0  8.1   0:00.31 java
</span></span></span><span class=line><span class=cl><span class=go>  99 root      20   0 8622220   5.1g  15640 S  0.0  8.1   0:00.32 java
</span></span></span></code></pre></div></article><div class="gdoc-page__footer flex flex-wrap justify-between"></div></div></main><footer class=gdoc-footer><div class="container flex flex-wrap"><span class=gdoc-footer__item>Copyright © 2020-2022 <a href=https://www.nxest.com class=gdoc-footer__link>nxest.com</a>.</span></div></footer></div><script defer src=/bits-pieces/js/en.search.min.js></script>
<script defer src=/bits-pieces/js/clipboard.min.js></script>
<script>document.addEventListener("DOMContentLoaded",function(){var t=new ClipboardJS(".clip")})</script></body></html>