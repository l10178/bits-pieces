<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>从 Spring 到 Spring Boot | bits-pieces</title><link rel=icon href=/bits-pieces/favicon/favicon-32x32.png type=image/x-icon><link rel=stylesheet href=/bits-pieces/main.min.css media=screen><link rel=stylesheet href=/bits-pieces/custom.css media=screen><link rel=alternate type=application/rss+xml href=https://l10178.github.io/bits-pieces/java/spring-boot/index.xml title=bits-pieces></head><body><div class=wrapper><input type=checkbox class=hidden id=menu-control><header class=gdoc-header><div class="container flex align-center justify-between"><label for=menu-control class=gdoc-nav__control><svg class="icon menu"><use xlink:href="#menu"/></svg><svg class="icon arrow-back"><use xlink:href="#arrow_back"/></svg></label><a class=gdoc-header__link href=https://l10178.github.io/bits-pieces/><span class="gdoc-brand flex align-center"><img class=gdoc-brand__img src=/bits-pieces/images/logos/logo.png alt=bits-pieces width=38 height=38>
bits-pieces</span></a></div></header><main class="container flex flex-even"><aside class=gdoc-nav><nav><div class=gdoc-search><svg class="icon search"><use xlink:href="#search"/></svg><input type=text id=gdoc-search-input class=gdoc-search__input placeholder=Search... aria-label=Search maxlength=64><div class="gdoc-search__spinner spinner hidden"></div><ul id=gdoc-search-results class=gdoc-search__list></ul></div><section class=gdoc-nav--main><h2>Navigation</h2><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/devops/ class=gdoc-nav__entry>DevOps</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/devops/mysql5.7to8.0/ class=gdoc-nav__entry>MySQL5.7升级至8.0</a></span></li><li><span class=flex><a href=/bits-pieces/devops/mysql-large-import/ class=gdoc-nav__entry>MySQL大文件导入优化</a></span></li><li><span class=flex><a href=/bits-pieces/devops/nexus/ class=gdoc-nav__entry>Nexus3 批量导入</a></span></li><li><span class=flex><a href=/bits-pieces/devops/superset/ class=gdoc-nav__entry>Superset 对接 ClickHouse</a></span></li><li><span class=flex><a href=/bits-pieces/devops/cdr/ class=gdoc-nav__entry>使用Visual Studio Code搭建多用户远程IDE</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/java/ class=gdoc-nav__entry>Java</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/java/jvm/ class=gdoc-nav__entry>Java进程内存分析</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring-boot-micrometer/ class=gdoc-nav__entry>Spring Boot 使用 Micrometer 集成 Prometheus 监控</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring-start-site/ class=gdoc-nav__entry>Spring Start脚手架快速入门</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring-boot/ class="gdoc-nav__entry is-active">从 Spring 到 Spring Boot</a></span></li></ul></li><li><span class=flex>Kubernetes</span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/kubernetes/envoy/ class=gdoc-nav__entry>Envoy生产配置最佳实践</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/tldr/ class=gdoc-nav__entry>TL;DR</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/cka/ class=gdoc-nav__entry>备考 CKA 过程，CKA 真题</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/pid/ class=gdoc-nav__entry>容器进程数限制</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/linux/ class=gdoc-nav__entry>Linux</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/linux/regular-expressions/ class=gdoc-nav__entry>Regular Expressions</a></span></li><li><span class=flex><a href=/bits-pieces/linux/git/ class=gdoc-nav__entry>Git常用配置</a></span></li><li><span class=flex><a href=/bits-pieces/linux/history/ class=gdoc-nav__entry>History入门</a></span></li><li><span class=flex><a href=/bits-pieces/linux/pngquant/ class=gdoc-nav__entry>PNG图片批量压缩</a></span></li><li><span class=flex><a href=/bits-pieces/linux/shell-coding/ class=gdoc-nav__entry>Shell 编程实用句式</a></span></li><li><span class=flex><a href=/bits-pieces/linux/tcpdump/ class=gdoc-nav__entry>tcpdump</a></span></li><li><span class=flex><a href=/bits-pieces/linux/transaction/ class=gdoc-nav__entry>数据库事务控制</a></span></li><li><span class=flex><a href=/bits-pieces/linux/tar.gz/ class=gdoc-nav__entry>文件压缩解压</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/windows/ class=gdoc-nav__entry>Windows</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/windows/takeown/ class=gdoc-nav__entry>Windows提权 + 设置环境变量</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/knives/ class=gdoc-nav__entry>瑞士军刀</a></span></li></ul></section><section class=gdoc-nav--more><h2>More</h2><ul class=gdoc-nav__list><li><span class=flex><svg class="icon download"><use xlink:href="#download"/></svg><a href=https://github.com/l10178/bits-pieces/releases class=gdoc-nav__entry>Releases</a></span></li><li><span class=flex><svg class="icon github"><use xlink:href="#github"/></svg><a href=https://github.com/l10178/bits-pieces class=gdoc-nav__entry>View Source</a></span></li></ul></section></nav></aside><div class=gdoc-page><div class="gdoc-page__header flex flex-wrap justify-between" itemscope itemtype=https://schema.org/Breadcrumb><span></span><span><svg class="icon code"><use xlink:href="#code"/></svg><a href=https://github.com/l10178/bits-pieces/edit/main/content/java/spring-boot/_index.md>Edit this page</a></span></div><article class=gdoc-markdown><h1>从 Spring 到 Spring Boot</h1><p>从 Spring 到 Spring Boot，迁移升级使用过程，以及各种踩坑记录。</p><div class=gdoc-page__anchorwrap><h2 id=概述>概述<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot/#概述 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 概述" href=#概述><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>从 Spring 到 Spring Boot，整体开发、运行方式主要变化。</p><table><thead><tr><th>-</th><th>当前模式</th><th>新模式（本地）</th><th>新模式（线上）</th></tr></thead><tbody><tr><td>开发习惯</td><td>Spring + 外置 Tomcat</td><td>Spring Boot（embed tomcat）</td><td>Spring Boot War + 外置 Tomcat</td></tr><tr><td>Java 版本</td><td>8、11、16、17</td><td>11、17（推荐）</td><td>11、17（推荐）</td></tr><tr><td>Tomcat 版本</td><td>8.x、9.x</td><td>9.x</td><td>9.x</td></tr></tbody></table><p>说明：</p><ol><li>理论上支持 Java11，但是要求业务方尽量使用 Java17。</li><li>线上运行支持 Spring Boot jar 直接运行，但只开放给部分业务组，主要业务仍以 war + tomcat 为主。如果希望以 <code>java -jar</code> 方式运行，参考下面的章节“jar 方式运行”描述。</li><li>目前 Spring Boot 主要推行版本是 2.7。 3.x 版本逐渐适配中。</li></ol><div class=gdoc-page__anchorwrap><h2 id=快速开始>快速开始<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot/#快速开始 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 快速开始" href=#快速开始><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><ol><li>线下支撑系统导航，点击 <code>脚手架</code> 进入 spring start 页面，按自己需求选择模块，生成自己业务模式初始化代码。</li><li>写（Copy）业务代码到项目里，修改 pom.xml 根据需要添加新的依赖。</li><li>查看本文档中 <code>遇见问题及解决方案</code> 章节，注意如果是老项目迁移，这一步很重要。</li><li>本地开发工具启动 main 方法。</li><li>上线发布系统，选择 <code>tomcat9:openjdk17</code> 镜像，并勾选 <code>镜像 JDK 版本编译代码</code>。</li></ol><p>以上生成的一个最简略的代码结构，更多复杂使用方式参考下方主要 starter 使用说明。</p><div class=gdoc-page__anchorwrap><h2 id=主要-starter-使用说明>主要 starter 使用说明<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot/#主要-starter-使用说明 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 主要 starter 使用说明" href=#主要-starter-使用说明><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>文档会延后，代码不会骗人，更多说明参考各个项目源码的 README，README 会实时更新。</p><div class=gdoc-page__anchorwrap><h3 id=fxiaoke-spring-cloud-parent>fxiaoke-spring-cloud-parent<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot/#fxiaoke-spring-cloud-parent class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor fxiaoke-spring-cloud-parent" href=#fxiaoke-spring-cloud-parent><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>目前有两个公司级父 pom：</p><ol><li>新：com.fxiaoke.cloud.fxiaoke-spring-cloud-parent 用于 Spring Boot/Cloud 方式开发。</li><li>旧：com.fxiaoke.common.fxiaoke-parent-pom 用于原纯 Spring + Tomcat 方式开发。</li></ol><p>注意：</p><ol><li>fxiaoke-spring-cloud-parent 导入了 fxiaoke-parent-pom，所以纷享包版本都是一致的，但是三方包比如 spring/netty/okhttp 会随 Spring Boot 版本。</li><li>旧 pom 区分线上和线下版本，新 pom 目前只有一份并不区分。</li></ol><p>Maven 项目 parent 统一使用公司新 parent pom，这里定义了 Spring Boot、Spring Cloud 以及内部定制的各种 support 和 starter 版本号。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;parent&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>com.fxiaoke.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>fxiaoke-spring-cloud-parent<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=c>&lt;!-- 注意使用最新版本，可以从脚手架里获取最新版本 --&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;version&gt;</span>1.2.0-SNAPSHOT<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl> <span class=nt>&lt;relativePath/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/parent&gt;</span>
</span></span></code></pre></div><p>主要升级项需关注：</p><ul><li>老项目切换到 Spring Boot 先分析实际生效的 maven dependency，关注下核心包版本是否有大的升级，是否可能对业务造成影响。</li><li>Spock and Groovy：Spock 由原来的 1.x 升级到 2.x 版本，同时 Groovy 升级到 4.x 版本，Junit4 升级到 Junit5。</li></ul><p>已知废弃依赖：</p><table><thead><tr><th>废弃项</th><th>替代项</th><th>说明</th></tr></thead><tbody><tr><td>javax.annotation-api</td><td>jakarta.annotation-api</td><td>随 spring boot 版本走，且两个包不能共存</td></tr></tbody></table><div class=gdoc-page__anchorwrap><h2 id=spring-boot-starter-actuator>spring-boot-starter-actuator<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot/#spring-boot-starter-actuator class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor spring-boot-starter-actuator" href=#spring-boot-starter-actuator><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>目前强制依赖 <code>spring-boot-starter-actuator</code>，容器镜像里使用它实现健康检查。
另外强制依赖 <code>spring-boot-starter-web</code>，因为有些基础组件依赖了 <code>ServletContext</code>。</p><p>注意：
actuator 的引入会带来一些额外收益，之前我们健康检测只检查服务端口是否有响应，而 actuator 默认还额外检查各个中间件的状态，业务方可根据需要自行增加或删除某些中间件的状态到健康检测服务，具体方式和更多高级应用参考 spring-boot-starter-actuator 官方文档。</p><div class=gdoc-page__anchorwrap><h2 id=cms-spring-cloud-starter>cms-spring-cloud-starter<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot/#cms-spring-cloud-starter class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor cms-spring-cloud-starter" href=#cms-spring-cloud-starter><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>配置中心 starter，类似 spring-cloud-consul/nacos/config，对接配置中心，实现配置文件动态加载、刷新，代替原 ReloadablePropertySourcesPlaceholderConfigurer。</p><p>使用步骤：</p><ol><li><p>引入 starter。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>     <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;groupId&gt;</span>com.fxiaoke.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;artifactId&gt;</span>cms-spring-cloud-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>     <span class=c>&lt;!-- 版本号建议不写，使用 parent 定义好的版本 --&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div></li><li><p>增加 src/main/resources/application.properties 文件，内容如下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=c1># 当前模块名，必填，必须全局唯一，一般和 maven 子模块保持一致</span>
</span></span><span class=line><span class=cl><span class=na>spring.application.name</span><span class=o>=</span><span class=s>cms-starter-sample</span>
</span></span><span class=line><span class=cl><span class=c1># 配置导入，这一行必须写。但是配置文件本身是否必须是通过 optional 控制的</span>
</span></span><span class=line><span class=cl><span class=na>spring.config.import</span><span class=o>=</span><span class=s>optional:cms:${spring.application.name}</span>
</span></span></code></pre></div><p>我们使用 <code>spring.config.import</code> 固定格式为 <code>optional:cms:file-name</code>。
optional 表示这个文件可选，配置中心不存在的时候也允许启动，<code>cms</code> 是固定字符代表对接 fs 配置中心。</p></li><li><p>在 CMS 配置中心创建需要的配置文件，文件名为 <code>spring-cloud-${spring.application.name}</code>，其中${spring.application.name}替换成真正的文件名，注意当前版本自动追加了前缀<code>spring-cloud-</code>且不允许修改。</p></li><li><p>代码中使用几种方式参考 sample 代码，文档查看 spring 官方<code>ConfigurationProperties</code>和 <code>@Value</code> 说明。</p></li><li><p>配置变更后，如果想响应变更事件，实现自己逻辑，自定义类中<code>implements ApplicationListener&lt;RefreshScopeRefreshedEvent></code></p></li><li><p>配置加解密，在配置中心中有个加密功能框（如果看不到可能是没有权限），先使用本 starter 的秘钥加密，使用固定格式 <code>ENC（加密后的内容）</code>配置到文件里，在 java 里 get value 就是已经解密后的了。例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>sample.sensitive</span><span class=o>=</span><span class=s>ENC(30E239E0958AF3179C7E8EBA3DF618FD)</span>
</span></span></code></pre></div></li></ol><p>响应配置更新：</p><ol><li><p>对于使用使用 ConfigurationProperties 映射的对象类，从对象中每次 get 的值都是刷新后的。推荐这种方式。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl> <span class=nd>@Data</span>
</span></span><span class=line><span class=cl> <span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl> <span class=nd>@ConfigurationProperties</span><span class=o>(</span><span class=n>prefix</span> <span class=o>=</span> <span class=s>&#34;sample&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl> <span class=kd>public</span> <span class=kd>class</span> <span class=nc>SampleProperties</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>     <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span></code></pre></div></li><li><p><code>@RefreshScope + @Value</code> 获取 Value 注解的新值。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span>
</span></span><span class=line><span class=cl><span class=nd>@RefreshScope</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ValueService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl> <span class=nd>@Value</span><span class=o>(</span><span class=s>&#34;${sample.over.value}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl> <span class=nd>@Getter</span>
</span></span><span class=line><span class=cl> <span class=kd>private</span> <span class=n>String</span> <span class=n>watchValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div></li><li><p>监听 RefreshScopeRefreshedEvent 事件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@EventListener</span><span class=o>(</span><span class=n>RefreshScopeRefreshedEvent</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>handlerPropertiesChangeEvent</span><span class=o>(</span><span class=n>RefreshScopeRefreshedEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl> <span class=c1>//此时配置 Bean 已刷新完成，处理自己的业务逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></div></li></ol><div class=gdoc-page__anchorwrap><h2 id=jar-方式运行>jar 方式运行<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot/#jar-方式运行 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor jar 方式运行" href=#jar-方式运行><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>如果不使用外置 Tomcat，使用 <code>java -jar</code> 方式直接运行，首先打包模式为 jar 并在发布时增加环境变量 <code>SPRING_BOOT_JAR_APP=true</code>。</p><p>与外置 Tomcat 模式差别：</p><ol><li>jar 模式一个 pod 内只能部署一个模块，不支持多模块合并部署。</li><li>jar 模式不会自动把 jar 解压成文件夹（war 模式会），所以关于文件资源的读写要特别注意，参考下面的问题描述章节。</li></ol><div class=gdoc-page__anchorwrap><h2 id=老项目迁移升级>老项目迁移升级<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot/#老项目迁移升级 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 老项目迁移升级" href=#老项目迁移升级><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><ol><li>POM 迁移，依赖项可能被开源软件主动提升版本，要注意版本变化。已知的组件会通过 fxiaoke parent 控制。</li><li>原有的 xml 配置，可以改为注解形式，也可以不改直接 <code>@ImportResource</code> 使用。</li><li>注意配置扫描范围，原来 xml 中可能是配置是某几个包，Spring Boot 默认扫描 Application.java 所在包，范围可能扩大。</li><li>原来 tomcat web.xml 相关配置，尤其是各种 filter、servlet，需要迁移。包括我们自定义的一些工具。</li><li>Unit Test 更换注解，目前默认 junit 版本是 junit5，原 junit4 注解位置变更。</li></ol><div class=gdoc-page__anchorwrap><h3 id=迁移辅助>迁移辅助<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot/#迁移辅助 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 迁移辅助" href=#迁移辅助><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>辅助工具： 使用 <a href=https://github.com/adoptium/emt4j>EMT4J</a> 提前扫描，通过静态检测指导从 Java 8 升级到 Java 17 需要注意的变更项。</p><div class=gdoc-page__anchorwrap><h3 id=war-配置转移>War 配置转移<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot/#war-配置转移 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor War 配置转移" href=#war-配置转移><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>If you try to migrate a Java legacy application to Spring Boot you will find out that <a href=https://github.com/spring-projects/spring-boot/issues/2175>Spring Boot ignores
the web.xml file</a> when it is run as embedded container.</p><p>webapp web.xml 配置如何转移到 spring boot war 形式。
参考：<a href=https://www.baeldung.com/spring-boot-dispatcherservlet-web-xml>https://www.baeldung.com/spring-boot-dispatcherservlet-web-xml</a></p><div class=gdoc-page__anchorwrap><h2 id=已知限制>已知限制<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot/#已知限制 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 已知限制" href=#已知限制><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>目前发现几个体验不太好的地方，正在想办法优化。</p><ul><li>引入我们的 support，常常触发 Spring Auto Config（尤其是 ConditionOnClass 类型的），而我们的 support 有些未适配成 starter，需要开发人员主动排除默认的实现。</li></ul><div class=gdoc-page__anchorwrap><h2 id=遇见问题及解决方案>遇见问题及解决方案<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot/#遇见问题及解决方案 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 遇见问题及解决方案" href=#遇见问题及解决方案><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><ul><li><p>com.google.common.io.Resources#getResource 无法获取到 jar 包内资源</p><p>如果是 <code>java -jar</code> 模式运行，这种方式是无法获取 jar 包内资源的，请切换到 <code>Spring way</code>，使用 Spring 提供的工具类。</p></li><li><p>PostConstruct 和 PreDestroy 注解不生效</p><p>原因：PostConstruct、PreDestroy 等注解可能存在多个实现或者过个版本，比如以下 jar 包都可能包含：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>      javax.annotation-api-1.3.2.jar
</span></span></span><span class=line><span class=cl><span class=go>      jakarta.annotation-api-1.3.5.jar
</span></span></span><span class=line><span class=cl><span class=go>      jboss-annotations-api_1.3_spec-2.0.1.Final.jar
</span></span></span></code></pre></div><p>解决方法：排除依赖，只保留 jakarta.annotation-api 一种，且只能有一个版本。</p></li><li><p>kafka 使用报错，日志类似如下：</p><pre tabindex=0><code class=language-log data-lang=log>ERROR c.f.s.SenderManager cannot send, org.apache.kafka.common.KafkaException: org.apache.kafka.clients.producer.internals.DefaultPartitioner is not an instance of org.apache.kafka.clients.producer.Partitioner
</code></pre><p>原因：因为 classpath 下包含多个不同版本的 kafka-client.jar，检查依赖项，确保只引用一个版本。</p></li><li><p>告警：SLF4J: Class path contains multiple SLF4J bindings.</p><p>多个 jar 包含 SLF4J 实现，或引入了多个 logback 版本，请根据提示排除不需要的 jar 包。</p></li><li><p>XML 中使用 AOP 注解，运行期报错如下（建议用到 AOP 的提前检查，因为运行期才会报错）：JoinPointMatch ClassNotFoundException</p><pre tabindex=0><code class=language-log data-lang=log>Caused by: java.lang.ClassNotFoundException: org.aspectj.weaver.tools.JoinPointMatch
at org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1412)
at org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1220)
... 58 more
</code></pre><p>依赖 spring aop，请确认是否引入 <code>spring-boot-starter-aop</code>。</p></li><li><p>本地使用 Java 17 启动，类似如下报错。</p><pre tabindex=0><code class=language-log data-lang=log>ERROR o.s.b.SpringApplication Application run failed java.lang.reflect.InaccessibleObjectException: Unable to make protected final java.lang.Class java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain) throws java.lang.ClassFormatError accessible: module java.base does not &#34;opens java.lang&#34; to unnamed module @443118b0
      at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:354)
      at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:297)
      at java.base/java.lang.reflect.Method.checkCanSetAccessible(Method.java:199)
      at java.base/java.lang.reflect.Method.setAccessible(Method.java:193)
      at com.alibaba.dubbo.common.compiler.support.JavassistCompiler.doCompile(JavassistCompiler.java:123) [6 skipped]
      at com.alibaba.dubbo.common.compiler.support.AbstractCompiler.compile(AbstractCompiler.java:59)
      at com.alibaba.dubbo.common.compiler.support.AdaptiveCompiler.compile(AdaptiveCompiler.java:46)
</code></pre><p>本地命令行中启动参数里主动追加以下参数（这些参数在发布系统的镜像里默认已经加了），IDEA 启动是设置到<code>VM options</code>里：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>--add-opens<span class=o>=</span>java.base/java.lang.reflect<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.math<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.lang<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.io<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.util<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.util.concurrent<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.rmi/sun.rmi.transport<span class=o>=</span>ALL-UNNAMED
</span></span></code></pre></div></li><li><p>Bean 重复定义错误，报错信息类似如下。</p><pre tabindex=0><code class=language-log data-lang=log>The bean &#39;eieaConverterImpl&#39;, defined in class path resource [spring/ei-ea-converter.xml], could not be registered. A bean with that name has already been defined in class path resource [spring/ei-ea-converter.xml] and overriding is disabled.
Action:
Consider renaming one of the beans or enabling overriding by setting spring.main.allow-bean-definition-overriding=true
</code></pre><p>可能因为注解扫描范围增广或者有同样包多版本引入，导致扫描到多个。确认多处定义是否一致，如果不一致查看原项目哪个生效，以生效为准。如果一致，找到定义的地方查看是否能整个文件排除掉，实在不能在 application.properties 中设置 spring.main.allow-bean-definition-overriding=true 可解决。</p></li><li><p>如下报错 <code>class xxx is not visible from class loader</code>，常见于 dubbo 服务。</p><p>解决办法：不要用 spring-boot-devtools。 参考链接：<a href=https://blog.csdn.net/zhailuxu/article/details/79305661>https://blog.csdn.net/zhailuxu/article/details/79305661</a></p></li><li><p>dubbo 服务 <code>java.io.IOException: invalid constant type: 18</code>，日志类似如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Wrapped by: java.lang.IllegalStateException: Can not create adaptive extenstion interface com.alibaba.dubbo.rpc.Protocol, cause: java.io.IOExc
</span></span></span><span class=line><span class=cl><span class=go>eption: invalid constant type: 18
</span></span></span><span class=line><span class=cl><span class=go>   at com.alibaba.dubbo.common.extension.ExtensionLoader.createAdaptiveExtension(ExtensionLoader.java:723)
</span></span></span><span class=line><span class=cl><span class=go>   at com.alibaba.dubbo.common.extension.ExtensionLoader.getAdaptiveExtension(ExtensionLoader.java:455)
</span></span></span><span class=line><span class=cl><span class=go>   ... 29 common frames omitted
</span></span></span><span class=line><span class=cl><span class=go>Wrapped by: java.lang.IllegalStateException: fail to create adaptive instance: java.lang.IllegalStateException: Can not create adaptive extens
</span></span></span><span class=line><span class=cl><span class=go>tion interface com.alibaba.dubbo.rpc.Protocol, cause: java.io.IOException: invalid constant type: 18
</span></span></span><span class=line><span class=cl><span class=go>   at com.alibaba.dubbo.common.extension.ExtensionLoader.getAdaptiveExtension(ExtensionLoader.java:459)
</span></span></span><span class=line><span class=cl><span class=go>   at com.alibaba.dubbo.config.ServiceConfig.&lt;clinit&gt;(ServiceConfig.java:51)
</span></span></span><span class=line><span class=cl><span class=go>   ... 28 common frames omitted
</span></span></span></code></pre></div><p>原因：缺少 javassist 或 javassist 版本太低。目前可用的版本是 <code>javassist:javassist:3.27.0-GA</code>。</p></li><li><p>Spring Auto Configuration 常见排除：</p><p>Spring 默认增加很多 Auto Configuration，使用 support 时可能触发 Auto Configuration 但又缺少配置，可主动排除掉。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootApplication</span><span class=o>(</span><span class=n>exclude</span> <span class=o>=</span> <span class=o>{</span><span class=n>DataSourceAutoConfiguration</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>MongoDataAutoConfiguration</span><span class=o>.</span><span class=na>class</span><span class=o>})</span>
</span></span></code></pre></div></li></ul><div class=gdoc-page__anchorwrap><h2 id=参考资料>参考资料<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot/#参考资料 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 参考资料" href=#参考资料><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><ul><li>我服了！SpringBoot 升级后这服务我一个星期都没跑起来：
<a href="https://www.toutiao.com/article/7163602391366074916/?app=news_article&amp;timestamp=1667992250&amp;use_new_style=1&amp;req_id=20221109191050010158031044021CE00D&amp;group_id=7163602391366074916&amp;share_token=A8B008C4-29B7-4ADD-8636-3A17BA91A3BA&amp;tt_from=weixin&amp;utm_source=weixin&amp;utm_medium=toutiao_ios&amp;utm_campaign=client_share&amp;wxshare_count=1&amp;source=m_redirect&amp;wid=1668061929517">https://www.toutiao.com/article/7163602391366074916/?app=news_article&amp;timestamp=1667992250&amp;use_new_style=1&amp;req_id=20221109191050010158031044021CE00D&amp;group_id=7163602391366074916&amp;share_token=A8B008C4-29B7-4ADD-8636-3A17BA91A3BA&amp;tt_from=weixin&amp;utm_source=weixin&amp;utm_medium=toutiao_ios&amp;utm_campaign=client_share&amp;wxshare_count=1&amp;source=m_redirect&amp;wid=1668061929517</a></li></ul></article><div class="gdoc-page__footer flex flex-wrap justify-between"></div></div></main><footer class=gdoc-footer><div class="container flex flex-wrap"><span class=gdoc-footer__item>Copyright © 2020-2022 <a href=https://www.nxest.com class=gdoc-footer__link>nxest.com</a>.</span></div></footer></div><script defer src=/bits-pieces/js/en.search.min.js></script>
<script defer src=/bits-pieces/js/clipboard.min.js></script>
<script>document.addEventListener("DOMContentLoaded",function(){var t=new ClipboardJS(".clip")})</script></body></html>