<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>从Spring到Spring Cloud | bits-pieces</title><link rel=icon href=/bits-pieces/favicon/favicon-32x32.png type=image/x-icon><link rel=stylesheet href=/bits-pieces/main.min.css media=screen><link rel=stylesheet href=/bits-pieces/custom.css media=screen><link rel=alternate type=application/rss+xml href=https://l10178.github.io/bits-pieces/java/spring/index.xml title=bits-pieces></head><body><div class=wrapper><input type=checkbox class=hidden id=menu-control><header class=gdoc-header><div class="container flex align-center justify-between"><label for=menu-control class=gdoc-nav__control><svg class="icon menu"><use xlink:href="#menu"/></svg><svg class="icon arrow-back"><use xlink:href="#arrow_back"/></svg></label><a class=gdoc-header__link href=https://l10178.github.io/bits-pieces/><span class="gdoc-brand flex align-center"><img class=gdoc-brand__img src=/bits-pieces/images/logos/logo.png alt=bits-pieces width=38 height=38>
bits-pieces</span></a></div></header><main class="container flex flex-even"><aside class=gdoc-nav><nav><div class=gdoc-search><svg class="icon search"><use xlink:href="#search"/></svg><input type=text id=gdoc-search-input class=gdoc-search__input placeholder=Search... aria-label=Search maxlength=64><div class="gdoc-search__spinner spinner hidden"></div><ul id=gdoc-search-results class=gdoc-search__list></ul></div><section class=gdoc-nav--main><h2>Navigation</h2><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/devops/ class=gdoc-nav__entry>DevOps</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/devops/mysql5.7to8.0/ class=gdoc-nav__entry>MySQL5.7升级至8.0</a></span></li><li><span class=flex><a href=/bits-pieces/devops/mysql-large-import/ class=gdoc-nav__entry>MySQL大文件导入优化</a></span></li><li><span class=flex><a href=/bits-pieces/devops/nexus/ class=gdoc-nav__entry>Nexus3 批量导入</a></span></li><li><span class=flex><a href=/bits-pieces/devops/superset/ class=gdoc-nav__entry>Superset 对接 ClickHouse</a></span></li><li><span class=flex><a href=/bits-pieces/devops/cdr/ class=gdoc-nav__entry>使用Visual Studio Code搭建多用户远程IDE</a></span></li></ul></li><li><span class=flex>Javas</span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/java/jvm/ class=gdoc-nav__entry>Java进程内存分析</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring-start-site/ class=gdoc-nav__entry>Spring Start脚手架快速入门</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring/ class="gdoc-nav__entry is-active">从Spring到Spring Cloud</a></span></li></ul></li><li><span class=flex>Kubernetes</span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/kubernetes/envoy/ class=gdoc-nav__entry>Envoy生产配置最佳实践</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/tldr/ class=gdoc-nav__entry>TL;DR</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/cka/ class=gdoc-nav__entry>备考 CKA 过程，CKA 真题</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/linux/ class=gdoc-nav__entry>Linux</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/linux/regular-expressions/ class=gdoc-nav__entry>Regular Expressions</a></span></li><li><span class=flex><a href=/bits-pieces/linux/git/ class=gdoc-nav__entry>Git常用配置</a></span></li><li><span class=flex><a href=/bits-pieces/linux/history/ class=gdoc-nav__entry>History入门</a></span></li><li><span class=flex><a href=/bits-pieces/linux/pngquant/ class=gdoc-nav__entry>PNG图片批量压缩</a></span></li><li><span class=flex><a href=/bits-pieces/linux/shell-coding/ class=gdoc-nav__entry>Shell 编程实用句式</a></span></li><li><span class=flex><a href=/bits-pieces/linux/tcpdump/ class=gdoc-nav__entry>tcpdump</a></span></li><li><span class=flex><a href=/bits-pieces/linux/transaction/ class=gdoc-nav__entry>数据库事务控制</a></span></li><li><span class=flex><a href=/bits-pieces/linux/tar.gz/ class=gdoc-nav__entry>文件压缩解压</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/windows/ class=gdoc-nav__entry>Windows</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/windows/takeown/ class=gdoc-nav__entry>Windows提权 + 设置环境变量</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/knives/ class=gdoc-nav__entry>瑞士军刀</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/knives/ripgrep/ class=gdoc-nav__entry>ripgrep</a></span></li><li><span class=flex><a href=/bits-pieces/knives/tldr/ class=gdoc-nav__entry>TL;DR</a></span></li></ul></li></ul></section><section class=gdoc-nav--more><h2>More</h2><ul class=gdoc-nav__list><li><span class=flex><svg class="icon download"><use xlink:href="#download"/></svg><a href=https://github.com/l10178/bits-pieces/releases class=gdoc-nav__entry>Releases</a></span></li><li><span class=flex><svg class="icon github"><use xlink:href="#github"/></svg><a href=https://github.com/l10178/bits-pieces class=gdoc-nav__entry>View Source</a></span></li></ul></section></nav></aside><div class=gdoc-page><div class="gdoc-page__header flex flex-wrap justify-between" itemscope itemtype=https://schema.org/Breadcrumb><span></span><span><svg class="icon code"><use xlink:href="#code"/></svg><a href=https://github.com/l10178/bits-pieces/edit/main/content/java/spring/_index.md>Edit this page</a></span></div><article class=gdoc-markdown><h1>从Spring到Spring Cloud</h1><p>从 Spring 到 Spring Cloud，迁移升级使用指导，以及各种踩坑记录。</p><div class=gdoc-page__anchorwrap><h2 id=整体目标>整体目标<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#整体目标 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 整体目标" href=#整体目标><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>日常开发直接 run Spring Boot main 方法启动 embed tomcat，和开源方式一样。</p><p>运行方式：</p><ol><li>目前是打包成 war 以 Tomcat 9.x 版本运行。</li><li>暂只支持 Java 17 一个版本，如果业务有强烈需要再支持其他版本。</li></ol><div class=gdoc-page__anchorwrap><h2 id=业务方使用>业务方使用<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#业务方使用 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 业务方使用" href=#业务方使用><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>发布系统镜像：选择 tomcat9 系列。</p><div class=gdoc-page__anchorwrap><h2 id=spring-cloud-组件>Spring Cloud 组件<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#spring-cloud-组件 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor Spring Cloud 组件" href=#spring-cloud-组件><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>配置管理：
使用目前 CMS 配置中心，支持原有 ReloadablePropertyPostProcessor，另外定制 cms-starter，支持开源 property source 方式管理配置（推荐大家逐渐往这种方式迁移），支持配置自动刷新。
定制的这个 cms-starter 只支持 properties 格式。
配置中心支持自动加解密，定制的 starter 里实现（可参考开源项目<a href=https://github.com/ulisesbocchio/jasypt-spring-boot>https://github.com/ulisesbocchio/jasypt-spring-boot</a>）。</p><p>application.propeties 规划：在配置中心，application.propeties 通过 include 的方式引入 “通用+业务自定义”，通用包含 ES、Redis、Kafka 等等各通用组件定义如果有改动只需要改通用定义，各业务单独自定义一个文件。对客户端而言，拉取的就是一个 application 文件。各属性增加前缀，保证 key 不重复。</p><p>服务注册发现：
Nacos 作为 Server，新项目直接使用 Spring Cloud Alibaba Nacos，老项目使用 nacos-support。</p><p>Http Client：
原 http-spring-support 继续保留沿用，老项目和迁移过渡期间使用。
新服务希望能基于 Spring Cloud OpenFeign/RestTemplate + Loadbalancer，做一些定制融合我们的服务发现、路由、埋点、流量摘除。</p><p>熔断限流降级：
使用 Spring Cloud Alibaba Sentinel。
目前我们有些 support 里已经内置了 Resilience4J，短期内替换不掉，仍然可用。</p><p>分布式事务：
使用 Spring Cloud Alibaba Seata。业务团队根据需要自行引入。</p><p>各种数据库中间件：
目前的 redis、es、kafka supoort 仍然需要支持，否则业务侧代码改动较大。封装成 starter 一键引入和配置。
开源方式使用起来并不冲突，但是缺少 Trace 等一些定制化内容，逐渐封装增加切入点向开源方式靠近。</p><p>分布式任务调度：
继续使用 xxl-job。</p><p>网关：
暂不动。后续考虑 Spring Cloud Gateway or Service Mesh。</p><p>测试框架：
spock + Junit5，根据业务现有运行模式自行选择，默认不引入 junit4，如果有需要的自行引入。</p><p>其他：
spring-boot-actuator: 可代替健康检查，补充 logging 管理代替目前 logconf，补充部分 metrics。
Logging：外置 fluent-bit 负责全部的日志采集，替换掉现有 logback appender，制定日志规范。
Metrics：现有 CountService 能否切换到 Open Metrics，用开源替代。</p><div class=gdoc-page__anchorwrap><h2 id=starter-迁移>Starter 迁移<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#starter-迁移 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor Starter 迁移" href=#starter-迁移><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>父 POM 规划：
新建 fs spring-cloud-parent，原 partent pom 保留给老项目用，这两个 pom 共存挺长一段时间。
新 pom 会 import spring-cloud-dependencies 和 spring-cloud-alibaba-dependencies。
新 pom 里涵盖原有 pom 的各个组件定义，但是组件版本<code>能升尽升</code>（开源组件随 spring-cloud-dependencies）。例外：原来有定制的不升级，比如 dubbo、druid，强依赖环境的组件不升级，比如 kafka、ES 和 server 都有配套关系。</p><p>目前已封装的 Starter 迁移指导：
xxx：xxx 示例 es starter。</p><div class=gdoc-page__anchorwrap><h2 id=开发规范>开发规范<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#开发规范 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 开发规范" href=#开发规范><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><ul><li>强制启用 Spring Cloud bootstrap，bootstrap.properties 必须包含如下项：</li></ul><pre><code class=language-properties data-lang=properties># name在很多开源组件中都有严格的语义，需要指定且全局唯一不能变
spring.application.name=your-unique-name
</code></pre><ul><li>应用名：包含业务语义且全局唯一。</li></ul><div class=gdoc-page__anchorwrap><h3 id=包命名规范>包命名规范<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#包命名规范 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 包命名规范" href=#包命名规范><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>类名唯一避免 Jacoco 扫描覆盖。</p><div class=gdoc-page__anchorwrap><h3 id=test-规范>Test 规范<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#test-规范 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor Test 规范" href=#test-规范><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>要求 Test 默认必须能跑通过。</p><div class=gdoc-page__anchorwrap><h3 id=spring>Spring<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#spring class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor Spring" href=#spring><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>所有 spring 的包必须由 spring starter 引入，类似以下这种主动直接删掉。
AspectJ 通过 spring-boot-starter-aop 引入。</p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml>        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.springframework<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>spring-core<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>${spring.version}<span class=nt>&lt;/version&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.springframework<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>spring-context<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>${spring.version}<span class=nt>&lt;/version&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.springframework<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>spring-context-support<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>${spring.version}<span class=nt>&lt;/version&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>

        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.springframework<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>spring-test<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>${spring.version}<span class=nt>&lt;/version&gt;</span>
            <span class=nt>&lt;scope&gt;</span>test<span class=nt>&lt;/scope&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>

        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.aspectj<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>aspectjrt<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>${aspectj.version}<span class=nt>&lt;/version&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.aspectj<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>aspectjweaver<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>${aspectj.version}<span class=nt>&lt;/version&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
</code></pre></div><div class=gdoc-page__anchorwrap><h3 id=日志规范>日志规范<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#日志规范 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 日志规范" href=#日志规范><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>pom log 引入，去掉所有主动引入的 logback 和 slf4j 相关依赖，由 spring-boot-starter-logging 自动引入，类似以下这种直接删掉（注意：如果某模块有对 logback 的定制，注意验证兼容性）。</p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml>    <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.slf4j<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>slf4j-api<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>1.7.13<span class=nt>&lt;/version&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.slf4j<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>log4j-over-slf4j<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>1.7.13<span class=nt>&lt;/version&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
                <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>ch.qos.logback<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>logback-core<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>1.1.7<span class=nt>&lt;/version&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>ch.qos.logback<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>logback-classic<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>1.1.7<span class=nt>&lt;/version&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
</code></pre></div><p>Logback 配置文件统一将 logback.xml 改为 logback-spring.xml，内容约束如下：</p><p>日志打印规范。</p><div class=gdoc-page__anchorwrap><h2 id=老项目迁移升级>老项目迁移升级<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#老项目迁移升级 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 老项目迁移升级" href=#老项目迁移升级><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><ol><li>POM 迁移，依赖项可能被开源软件主动提升版本，要注意版本变化。已知的组件会通过 fxiaoke parent 控制。</li><li>原有的 xml 配置，可以改为注解形式，也可以不改直接 import 使用。</li><li>注意配置扫描范围，原来 xml 中可能是配置是某几个包，Spring Boot 默认扫描 Application.java 所在包，范围可能扩大。</li><li>原来 tomcat web.xml 相关配置，尤其是各种 filter、servlet，需要迁移。包括我们自定义的一些工具。</li><li>Unit Test 更换注解，目前默认 junit 版本是 junit5，原 junit4 注解位置变更。</li></ol><div class=gdoc-page__anchorwrap><h3 id=迁移辅助>迁移辅助<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#迁移辅助 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 迁移辅助" href=#迁移辅助><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>参考文章：
辅助工具：EMT4J 使用，静态检测指导从 Java 8 升级到 Java 17，发布系统做入口。</p><div class=gdoc-page__anchorwrap><h3 id=war-配置转移>War 配置转移<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#war-配置转移 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor War 配置转移" href=#war-配置转移><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>If you try to migrate a Java legacy application to Spring Boot you will find out that <a href=https://github.com/spring-projects/spring-boot/issues/2175>Spring Boot ignores
the web.xml file</a> when it is run as embedded container.</p><p>webapp web.xml 配置如何转移到 spring boot war 形式。
参考：<a href=https://www.baeldung.com/spring-boot-dispatcherservlet-web-xml>https://www.baeldung.com/spring-boot-dispatcherservlet-web-xml</a></p><div class=gdoc-page__anchorwrap><h3 id=jsp>JSP<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#jsp class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor JSP" href=#jsp><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>好吧，我们还有 JSP。
TODO： 404</p><div class=gdoc-page__anchorwrap><h3 id=cms-配置文件迁移方式>CMS 配置文件迁移方式<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#cms-配置文件迁移方式 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor CMS 配置文件迁移方式" href=#cms-配置文件迁移方式><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>参考新配置文件使用规范。</p><p>原 spring-cms.xml 典型配置如：</p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml>    <span class=nt>&lt;bean</span> <span class=na>class=</span><span class=s>&#34;com.github.autoconf.spring.reloadable.ReloadablePropertyPostProcessor&#34;</span> <span class=na>c:placeholderConfigurer-ref=</span><span class=s>&#34;autoConf&#34;</span><span class=nt>/&gt;</span>
    <span class=nt>&lt;bean</span> <span class=na>id=</span><span class=s>&#34;autoConf&#34;</span> <span class=na>class=</span><span class=s>&#34;com.github.autoconf.spring.reloadable.ReloadablePropertySourcesPlaceholderConfigurer&#34;</span>
          <span class=na>p:fileEncoding=</span><span class=s>&#34;UTF-8&#34;</span>
          <span class=na>p:ignoreResourceNotFound=</span><span class=s>&#34;true&#34;</span>
          <span class=na>p:ignoreUnresolvablePlaceholders=</span><span class=s>&#34;false&#34;</span>
          <span class=na>p:location=</span><span class=s>&#34;classpath:application.properties&#34;</span>
          <span class=na>p:configName=</span><span class=s>&#34;online-manage-provider&#34;</span><span class=nt>/&gt;</span>
</code></pre></div><p>使用举例和迁移指导，请参考资料中迁移指导。</p><div class=gdoc-page__anchorwrap><h2 id=已知限制>已知限制<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#已知限制 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 已知限制" href=#已知限制><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>目前发现几个体验不太好的地方，正在想办法优化。</p><ul><li>引入我们的 support，常常触发 Spring Auto Config（尤其是 ConditionOnClass 类型的），而我们的 support 有些未适配成 starter，需要开发人员排除默认的实现。</li></ul><div class=gdoc-page__anchorwrap><h2 id=遇见问题及解决方案>遇见问题及解决方案<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#遇见问题及解决方案 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 遇见问题及解决方案" href=#遇见问题及解决方案><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><ul><li>PostConstruct 和 PreDestroy 注解不生效</li></ul><p>原因：PostConstruct、PreDestroy 等注解可能存在多个实现或者过个版本，比如以下 jar 包都可能包含：</p><pre><code class=language-console data-lang=console>        javax.annotation-api-1.3.2.jar
        jakarta.annotation-api-1.3.5.jar
        jboss-annotations-api_1.3_spec-2.0.1.Final.jar
</code></pre><p>解决方法：排除依赖，只保留 jakarta.annotation-api 一种，且只能有一个版本。</p><ul><li>kafka 使用报错，日志类似如下：</li></ul><pre><code class=language-log data-lang=log>ERROR c.f.s.SenderManager cannot send, org.apache.kafka.common.KafkaException: org.apache.kafka.clients.producer.internals.DefaultPartitioner is not an instance of org.apache.kafka.clients.producer.Partitioner
</code></pre><p>原因：因为 classpath 下包含多个不同版本的 kafka-client.jar，检查依赖项，确保只引用一个版本。</p><ul><li>告警：SLF4J: Class path contains multiple SLF4J bindings.</li></ul><p>多个 jar 包含 SLF4J 实现，或引入了多个 logback 版本，请根据提示排除不需要的 jar 包。</p><ul><li>XML 中使用 AOP 注解，运行期报错如下（建议用到 AOP 的提前检查，因为运行期才会报错）：JoinPointMatch ClassNotFoundException</li></ul><pre><code class=language-log data-lang=log> Caused by: java.lang.ClassNotFoundException: org.aspectj.weaver.tools.JoinPointMatch
  at org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1412)
  at org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1220)
  ... 58 more
</code></pre><p>依赖 spring aop，请确认是否引入 <code>spring-boot-starter-aop</code>。</p><ul><li>本地使用 Java 17 启动，类似如下报错。</li></ul><pre><code class=language-log data-lang=log>ERROR o.s.b.SpringApplication Application run failed java.lang.reflect.InaccessibleObjectException: Unable to make protected final java.lang.Class java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain) throws java.lang.ClassFormatError accessible: module java.base does not &quot;opens java.lang&quot; to unnamed module @443118b0
        at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:354)
        at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:297)
        at java.base/java.lang.reflect.Method.checkCanSetAccessible(Method.java:199)
        at java.base/java.lang.reflect.Method.setAccessible(Method.java:193)
        at com.alibaba.dubbo.common.compiler.support.JavassistCompiler.doCompile(JavassistCompiler.java:123) [6 skipped]
        at com.alibaba.dubbo.common.compiler.support.AbstractCompiler.compile(AbstractCompiler.java:59)
        at com.alibaba.dubbo.common.compiler.support.AdaptiveCompiler.compile(AdaptiveCompiler.java:46)
</code></pre><p>本地命令行中启动参数里主动追加以下参数（这些参数在发布系统的镜像里默认已经加了），IDEA 启动是设置到<code>VM options</code>里：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>--add-opens<span class=o>=</span>java.base/java.lang.reflect<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.math<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.lang<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.io<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.util<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.util.concurrent<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.rmi/sun.rmi.transport<span class=o>=</span>ALL-UNNAMED
</code></pre></div><ul><li>Bean 重复定义错误，报错信息类似如下。</li></ul><pre><code class=language-log data-lang=log>The bean 'eieaConverterImpl', defined in class path resource [spring/ei-ea-converter.xml], could not be registered. A bean with that name has already been defined in class path resource [spring/ei-ea-converter.xml] and overriding is disabled.
Action:
Consider renaming one of the beans or enabling overriding by setting spring.main.allow-bean-definition-overriding=true
</code></pre><p>可能因为注解扫描范围增广或者有同样包多版本引入，导致扫描到多个。确认多处定义是否一致，如果不一致查看原项目哪个生效，以生效为准。如果一致，找到定义的地方查看是否能整个文件排除掉，实在不能再设置 spring.main.allow-bean-definition-overriding=true。</p><ul><li>如下报错 <code>class xxx is not visible from class loader</code>，常见于 dubbo 服务。
解决办法：不要用 spring-boot-devtools。 参考链接：<a href=https://blog.csdn.net/zhailuxu/article/details/79305661>https://blog.csdn.net/zhailuxu/article/details/79305661</a></li><li>dubbo 服务 <code>java.io.IOException: invalid constant type: 18</code>，日志类似如下：</li></ul><pre><code class=language-console data-lang=console>Wrapped by: java.lang.IllegalStateException: Can not create adaptive extenstion interface com.alibaba.dubbo.rpc.Protocol, cause: java.io.IOExc
eption: invalid constant type: 18
    at com.alibaba.dubbo.common.extension.ExtensionLoader.createAdaptiveExtension(ExtensionLoader.java:723)
    at com.alibaba.dubbo.common.extension.ExtensionLoader.getAdaptiveExtension(ExtensionLoader.java:455)
    ... 29 common frames omitted
Wrapped by: java.lang.IllegalStateException: fail to create adaptive instance: java.lang.IllegalStateException: Can not create adaptive extens
tion interface com.alibaba.dubbo.rpc.Protocol, cause: java.io.IOException: invalid constant type: 18
    at com.alibaba.dubbo.common.extension.ExtensionLoader.getAdaptiveExtension(ExtensionLoader.java:459)
    at com.alibaba.dubbo.config.ServiceConfig.&lt;clinit&gt;(ServiceConfig.java:51)
    ... 28 common frames omitted
</code></pre><p>原因：缺少 javassist 或 javassist 版本太低。目前可用的版本是 <code>javassist:javassist:3.27.0-GA</code>。</p><ul><li>Spring Auto Configuration 常见排除：</li></ul><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=nd>@SpringBootApplication</span><span class=o>(</span><span class=n>exclude</span> <span class=o>=</span> <span class=o>{</span><span class=n>DataSourceAutoConfiguration</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>MongoDataAutoConfiguration</span><span class=o>.</span><span class=na>class</span><span class=o>})</span>
</code></pre></div><div class=gdoc-page__anchorwrap><h2 id=参考资料>参考资料<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring/#参考资料 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 参考资料" href=#参考资料><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>Spring 升级教训：
<a href="https://www.toutiao.com/article/7163602391366074916/?app=news_article&timestamp=1667992250&use_new_style=1&req_id=20221109191050010158031044021CE00D&group_id=7163602391366074916&share_token=A8B008C4-29B7-4ADD-8636-3A17BA91A3BA&tt_from=weixin&utm_source=weixin&utm_medium=toutiao_ios&utm_campaign=client_share&wxshare_count=1&source=m_redirect&wid=1668061929517">https://www.toutiao.com/article/7163602391366074916/?app=news_article&timestamp=1667992250&use_new_style=1&req_id=20221109191050010158031044021CE00D&group_id=7163602391366074916&share_token=A8B008C4-29B7-4ADD-8636-3A17BA91A3BA&tt_from=weixin&utm_source=weixin&utm_medium=toutiao_ios&utm_campaign=client_share&wxshare_count=1&source=m_redirect&wid=1668061929517</a></p></article><div class="gdoc-page__footer flex flex-wrap justify-between"></div></div></main><footer class=gdoc-footer><div class="container flex flex-wrap"><span class=gdoc-footer__item>Copyright © 2020-2022 <a href=https://www.nxest.com class=gdoc-footer__link>nxest.com</a>.</span></div></footer></div><script defer src=/bits-pieces/js/en.search.min.js></script><script defer src=/bits-pieces/js/clipboard.min.js></script><script>document.addEventListener("DOMContentLoaded",function(event){var clipboard=new ClipboardJS('.clip');});</script></body></html>