<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Spring Boot 使用 Micrometer 集成 Prometheus 监控 | bits-pieces</title><link rel=icon href=/bits-pieces/favicon/favicon-32x32.png type=image/x-icon><link rel=stylesheet href=/bits-pieces/main.min.css media=screen><link rel=stylesheet href=/bits-pieces/custom.css media=screen><link rel=alternate type=application/rss+xml href=https://l10178.github.io/bits-pieces/java/spring-boot-micrometer/index.xml title=bits-pieces></head><body><div class=wrapper><input type=checkbox class=hidden id=menu-control><header class=gdoc-header><div class="container flex align-center justify-between"><label for=menu-control class=gdoc-nav__control><svg class="icon menu"><use xlink:href="#menu"/></svg><svg class="icon arrow-back"><use xlink:href="#arrow_back"/></svg></label><a class=gdoc-header__link href=https://l10178.github.io/bits-pieces/><span class="gdoc-brand flex align-center"><img class=gdoc-brand__img src=/bits-pieces/images/logos/logo.png alt=bits-pieces width=38 height=38>
bits-pieces</span></a></div></header><main class="container flex flex-even"><aside class=gdoc-nav><nav><div class=gdoc-search><svg class="icon search"><use xlink:href="#search"/></svg><input type=text id=gdoc-search-input class=gdoc-search__input placeholder=Search... aria-label=Search maxlength=64><div class="gdoc-search__spinner spinner hidden"></div><ul id=gdoc-search-results class=gdoc-search__list></ul></div><section class=gdoc-nav--main><h2>Navigation</h2><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/devops/ class=gdoc-nav__entry>DevOps</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/devops/mysql5.7to8.0/ class=gdoc-nav__entry>MySQL5.7升级至8.0</a></span></li><li><span class=flex><a href=/bits-pieces/devops/mysql-large-import/ class=gdoc-nav__entry>MySQL大文件导入优化</a></span></li><li><span class=flex><a href=/bits-pieces/devops/nexus/ class=gdoc-nav__entry>Nexus3 批量导入</a></span></li><li><span class=flex><a href=/bits-pieces/devops/superset/ class=gdoc-nav__entry>Superset 对接 ClickHouse</a></span></li><li><span class=flex><a href=/bits-pieces/devops/cdr/ class=gdoc-nav__entry>使用Visual Studio Code搭建多用户远程IDE</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/java/ class=gdoc-nav__entry>Java</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/java/jvm/ class=gdoc-nav__entry>Java进程内存分析</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring-boot-micrometer/ class="gdoc-nav__entry is-active">Spring Boot 使用 Micrometer 集成 Prometheus 监控</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring-start-site/ class=gdoc-nav__entry>Spring Start脚手架快速入门</a></span></li><li><span class=flex><a href=/bits-pieces/java/spring-boot/ class=gdoc-nav__entry>从Spring到Spring Boot</a></span></li></ul></li><li><span class=flex>Kubernetes</span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/kubernetes/envoy/ class=gdoc-nav__entry>Envoy生产配置最佳实践</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/tldr/ class=gdoc-nav__entry>TL;DR</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/cka/ class=gdoc-nav__entry>备考 CKA 过程，CKA 真题</a></span></li><li><span class=flex><a href=/bits-pieces/kubernetes/pid/ class=gdoc-nav__entry>容器进程数限制</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/linux/ class=gdoc-nav__entry>Linux</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/linux/regular-expressions/ class=gdoc-nav__entry>Regular Expressions</a></span></li><li><span class=flex><a href=/bits-pieces/linux/git/ class=gdoc-nav__entry>Git常用配置</a></span></li><li><span class=flex><a href=/bits-pieces/linux/history/ class=gdoc-nav__entry>History入门</a></span></li><li><span class=flex><a href=/bits-pieces/linux/pngquant/ class=gdoc-nav__entry>PNG图片批量压缩</a></span></li><li><span class=flex><a href=/bits-pieces/linux/shell-coding/ class=gdoc-nav__entry>Shell 编程实用句式</a></span></li><li><span class=flex><a href=/bits-pieces/linux/tcpdump/ class=gdoc-nav__entry>tcpdump</a></span></li><li><span class=flex><a href=/bits-pieces/linux/transaction/ class=gdoc-nav__entry>数据库事务控制</a></span></li><li><span class=flex><a href=/bits-pieces/linux/tar.gz/ class=gdoc-nav__entry>文件压缩解压</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/windows/ class=gdoc-nav__entry>Windows</a></span><ul class=gdoc-nav__list><li><span class=flex><a href=/bits-pieces/windows/takeown/ class=gdoc-nav__entry>Windows提权 + 设置环境变量</a></span></li></ul></li><li><span class=flex><a href=/bits-pieces/knives/ class=gdoc-nav__entry>瑞士军刀</a></span></li></ul></section><section class=gdoc-nav--more><h2>More</h2><ul class=gdoc-nav__list><li><span class=flex><svg class="icon download"><use xlink:href="#download"/></svg><a href=https://github.com/l10178/bits-pieces/releases class=gdoc-nav__entry>Releases</a></span></li><li><span class=flex><svg class="icon github"><use xlink:href="#github"/></svg><a href=https://github.com/l10178/bits-pieces class=gdoc-nav__entry>View Source</a></span></li></ul></section></nav></aside><div class=gdoc-page><div class="gdoc-page__header flex flex-wrap justify-between" itemscope itemtype=https://schema.org/Breadcrumb><span></span><span><svg class="icon code"><use xlink:href="#code"/></svg><a href=https://github.com/l10178/bits-pieces/edit/main/content/java/spring-boot-micrometer/_index.md>Edit this page</a></span></div><article class=gdoc-markdown><h1>Spring Boot 使用 Micrometer 集成 Prometheus 监控</h1><p>主要内容：</p><ol><li>Micrometer 介绍。</li><li>业务如何自定义指标，如何接入 Prometheus，实现方式和规范。</li></ol><div class=gdoc-page__anchorwrap><h2 id=micrometer-介绍>Micrometer 介绍<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot-micrometer/#micrometer-介绍 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor Micrometer 介绍" href=#micrometer-介绍><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>Micrometer 为 Java 平台上的性能数据收集提供了一个通用的 API，应用程序只需要使用 Micrometer 的通用 API 来收集性能指标，Micrometer 会负责完成与不同监控系统的适配工作。</p><p>Micrometer 提供了多种度量指标类型（Timers、Guauges、Counters 等），同时支持接入不同的监控系统，例如 Influxdb、Graphite、Prometheus、OTLP 等。</p><p>从 Spring Boot 2.x 开始使用 Micrometer 作为默认的监控门面接口， <code>Think SLF4J, but for observability</code> 。</p><div class=gdoc-page__anchorwrap><h3 id=micrometer-核心概念>Micrometer 核心概念<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot-micrometer/#micrometer-核心概念 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor Micrometer 核心概念" href=#micrometer-核心概念><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>Micrometer 中两个最核心的概念：计量器注册表 (MeterRegistry)，计量器 (Meter)。</p><ul><li><p>MeterRegistry</p><ul><li>内存注册表 (SimpleMeterRegistry): 在内存中保存每一个 Meter（指标）的最新值，并且不会将数据导出到任何地方。</li><li>组合注册表 (CompositeMeterRegistry): 可以添加多个注册表，用于将各个注册表组合起来，可以同时将指标发布到多个监控系统。Micrometer 提供了一个全局的 MeterRegistry，<code>io.micrometer.core.instrument.Metrics</code> 中持有一个静态 final 的 CompositeMeterRegistry 实例 globalRegistry。</li><li>普罗米修斯注册表 (PrometheusMeterRegistry): 当使用普罗米修斯监控时，引入 micrometer-registry-prometheus 依赖时会提供此种收集器，用于将指标数据转换为普罗米修斯识别的格式和导出数据等功能。</li></ul></li><li><p>Meter（指标）</p><p>监控数据的整个过程都是围绕着 Meter（指标）, 通过一个一个的 Meter（指标）数据来进行观察应用的状态。常用的指标如：</p><ul><li>Counter（计数器）: 单一计数指标，允许按固定数量递增，用来统计无上限数据。只允许递增。</li><li>Gauge（仪表盘）: 表示单个的变化的值，例如温度，气压。用于统计有上限可增可减的数据。在每次取样时，Gauge 会返回当前值。</li><li>Timer（计时器）: 通常用来记录事件的持续时间。Timer 会记录两类的数据，事件的数量和总的持续时间。</li></ul></li><li><p>Tag（标签）</p><p>Mircrometer 通过 Tag（标签）实现了多维度的度量数据收集，通过 Tag 的命名可以推断出其指向的数据代表什么维度或是什么类型的度量指标。</p></li></ul><div class=gdoc-page__anchorwrap><h2 id=当前实现方式和要求>当前实现方式和要求<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot-micrometer/#当前实现方式和要求 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 当前实现方式和要求" href=#当前实现方式和要求><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>总体架构： Spring Boot Actuator + Micrometer + Prometheus + Granfana。</p><p>总体实现步骤如下：</p><ol><li><p>Spring Boot Actuator 放开 <code>prometheus</code> http 访问，在配置文件中增加以下配置。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>management.endpoint.prometheus.enabled</span><span class=o>=</span><span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>management.endpoints.web.exposure.include</span><span class=o>=</span><span class=s>info,health,metrics,prometheus</span>
</span></span><span class=line><span class=cl><span class=na>management.metrics.export.prometheus.enabled</span><span class=o>=</span><span class=s>true</span>
</span></span></code></pre></div></li><li><p>创建 Prometheus <code>ServiceMonitor</code>，从 <code>/actuator/prometheus</code> path 采集指标，如果涉及多个 war 合并部署到一个 tomcat 的，从多个 path 采集。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceMonitor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>release</span><span class=p>:</span><span class=w> </span><span class=l>eye2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>eye-consumer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>honorLabels</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/client-biz/actuator/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>honorLabels</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/gateway-biz/actuator/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobLabel</span><span class=p>:</span><span class=w> </span><span class=l>eye-consumer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>eye-consumer</span><span class=w>
</span></span></span></code></pre></div></li><li><p>业务可通过 <code>http://localhost:8080/actuator/metrics</code> 查看指标是否已上报，通过 <code>http://localhost:8080/actuator/prometheus</code> 查看指标值。</p></li></ol><div class=gdoc-page__anchorwrap><h2 id=自定义-metrics-指标>自定义 Metrics 指标<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot-micrometer/#自定义-metrics-指标 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 自定义 Metrics 指标" href=#自定义-metrics-指标><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>在 Spring Boot 中实现自定义指标非常简单，几种方式举例如下。</p><ol><li>像使用 slf4j 一样，使用 <code>io.micrometer.core.instrument.Metrics</code> 静态方式初始化一个指标，然后使用此指标直接操作。</li><li>使用 <code>@Timed @Counted</code> 注解。注意注解方式必须等方法调用后才能生成指标。而静态方法形式 <code>io.micrometer.core.instrument.Metrics.counter</code>立即就生成指标只是值为 0。另外注意 Spring 注解不支持 private、default 级别方法。</li><li>使用 Autowired MeterRegistry 创建自己的指标类型，适合一些动态 Tag 等高级定制场景。</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>io.micrometer.core.annotation.Counted</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>io.micrometer.core.instrument.Counter</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>io.micrometer.core.instrument.Metrics</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.stereotype.Service</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Service</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MicrometerSampleService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 方式 1：像使用 slf4j 一样，使用 `io.micrometer.core.instrument.Metrics`静态方式初始化一个计数器，适用于名字和 Tag 固定的场景
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Counter</span> <span class=n>failure</span> <span class=o>=</span> <span class=n>Metrics</span><span class=o>.</span><span class=na>counter</span><span class=o>(</span><span class=s>&#34;fs.sms.send&#34;</span><span class=o>,</span> <span class=s>&#34;result&#34;</span><span class=o>,</span> <span class=s>&#34;failure&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>MeterRegistry</span> <span class=n>registry</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>void</span> <span class=nf>sendSms</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// do something
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>failure</span><span class=o>.</span><span class=na>increment</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 方式 2：使用注解的方式，注意需要引入 spring-boot-starter-aop 依赖
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Counted</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;fs.sms.send&#34;</span><span class=o>,</span> <span class=n>extraTags</span> <span class=o>=</span> <span class=o>{</span><span class=s>&#34;provider&#34;</span><span class=o>,</span> <span class=s>&#34;huawei&#34;</span><span class=o>})</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>sendByHuawei</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>sendSms</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Counted</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;fs.sms.send&#34;</span><span class=o>,</span> <span class=n>extraTags</span> <span class=o>=</span> <span class=o>{</span><span class=s>&#34;provider&#34;</span><span class=o>,</span> <span class=s>&#34;ali&#34;</span><span class=o>})</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>sendByAli</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>sendSms</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 方式 3：使用 MeterRegistry，适合一些动态 Tag 等高级定制场景
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * @param result result
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>countByResult</span><span class=o>(</span><span class=n>String</span> <span class=n>result</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=o>.</span><span class=na>counter</span><span class=o>(</span><span class=s>&#34;fs.sms.send&#34;</span><span class=o>,</span> <span class=s>&#34;result&#34;</span><span class=o>,</span> <span class=n>result</span><span class=o>).</span><span class=na>increment</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// or
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Counter</span><span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;fs.sms.send&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>description</span><span class=o>(</span><span class=s>&#34;send sms&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>tags</span><span class=o>(</span><span class=s>&#34;result&#34;</span><span class=o>,</span> <span class=n>result</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>registry</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>increment</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Spring Boot 无法直接使用 <code>@Timed @Counted</code> 注解，需要引入切面支持，需要引入 spring-boot-starter-aop 依赖。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MicrometerAspectConfiguration</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>CountedAspect</span> <span class=nf>countedAspect</span><span class=o>(</span><span class=n>MeterRegistry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>CountedAspect</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>TimedAspect</span> <span class=nf>timedAspect</span><span class=o>(</span><span class=n>MeterRegistry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>TimedAspect</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>为了方便大家使用，已经在我们的 starter 里自动注入了以上 Bean，大家只需要引入以下两个 starter。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;groupId&gt;</span>com.fxiaoke.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;artifactId&gt;</span>metrics-spring-boot-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-aop<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><div class=gdoc-page__anchorwrap><h3 id=自定义指标高级配置>自定义指标高级配置<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot-micrometer/#自定义指标高级配置 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 自定义指标高级配置" href=#自定义指标高级配置><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>Spring 默认注入的 MeterRegistry 是一个 CompositeMeterRegistry，如果想定制可注入自定义 MeterRegistryCustomizer Bean。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MicrometerConfiguration</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>  <span class=n>MeterRegistryCustomizer</span><span class=o>&lt;</span><span class=n>MeterRegistry</span><span class=o>&gt;</span> <span class=nf>configurer</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>(</span><span class=n>registry</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>registry</span><span class=o>.</span><span class=na>config</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>commonTags</span><span class=o>(</span><span class=s>&#34;group&#34;</span><span class=o>,</span> <span class=s>&#34;sample&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>commonTags</span><span class=o>(</span><span class=s>&#34;application&#34;</span><span class=o>,</span> <span class=s>&#34;sample&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>如果只是想为当前应用增加 Tag，可直接通过配置文件增加，示例如下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>management.metrics.tags.biz</span><span class=o>=</span><span class=s>sample</span>
</span></span><span class=line><span class=cl><span class=na>management.metrics.tags.application</span><span class=o>=</span><span class=s>${spring.application.name}</span>
</span></span></code></pre></div><p>TODO： Binders、 filters 放开？ 介绍</p><div class=gdoc-page__anchorwrap><h3 id=自定义指标规范>自定义指标规范<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot-micrometer/#自定义指标规范 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 自定义指标规范" href=#自定义指标规范><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><ol><li><p>指标和 Tag 命名约定使用英语句号分隔，全小写，Tag 可根据实际情况使用缩写。</p></li><li><p>指标命名建议以 <code>fs.application.action</code> 为模板，避免与开源或其他项目组冲突。</p></li><li><p>注意 Tag values 不能为 Null， 且必须是可枚举的某些固定类型便于统计。</p></li><li><p>使用注解<code>@Timed @Counted</code>会默认增加 <code>method、class、result、exception</code> 这几个 Tag，注意不要与之冲突。</p></li><li><p>公司和开源默认 Tag 如下，这些会被 ServiceMonitor 强制覆盖，业务不要自己定义。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>namespace、application、service、container、pod、instance、job、endpoint、id
</span></span></span></code></pre></div></li><li><p>编码中如果需要 MeterRegistry，不允许引用具体实现（比如 Prometheus 的 io.prometheus.client.CollectorRegistry），而是使用 Micrometer 提供的统一接口 <code>MeterRegistry</code>。类比，在打印日志时不允许直接使用 logback 或 log4j api，而是使用 slf4j api.</p></li><li><p>不要自己 new MeterRegistry，而是使用自动注入的或静态方法，因为我们可能随时在公司的 starter 增加自定义的配置。</p></li></ol><div class=gdoc-page__anchorwrap><h2 id=最佳实践>最佳实践<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot-micrometer/#最佳实践 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 最佳实践" href=#最佳实践><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><ol><li><p>合理规划 Tag，一个 Meter 具体类型需要通过名字和 Tag 作为它的唯一标识，这样做的好处是可以使用名字进行标记，通过不同的 Tag 去区分多种维度进行数据统计。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>反例 1（全部用 name 区分，无 Tag，重复计量）：
</span></span></span><span class=line><span class=cl><span class=go>  Metrics.counter(&#34;fs.sms.all&#34;);
</span></span></span><span class=line><span class=cl><span class=go>  Metrics.counter(&#34;fs.sms.aliyun&#34;);
</span></span></span><span class=line><span class=cl><span class=go>  Metrics.counter(&#34;fs.sms.huaweiyun&#34;);
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>正例：
</span></span></span><span class=line><span class=cl><span class=go>  Metrics.counter(&#34;fs.sms.send&#34;,&#34;provider&#34;,&#34;ali&#34;);
</span></span></span><span class=line><span class=cl><span class=go>  Metrics.counter(&#34;fs.sms.send&#34;,&#34;provider&#34;,&#34;huawei&#34;);
</span></span></span></code></pre></div></li><li><p>避免无意义不可枚举的 Tag，混乱的 Tag 比无 Tag 更难管理。</p></li></ol><div class=gdoc-page__anchorwrap><h2 id=注意事项>注意事项<a data-clipboard-text=https://l10178.github.io/bits-pieces/java/spring-boot-micrometer/#注意事项 class="gdoc-page__anchor gdoc-page__anchor--right clip" aria-label="Anchor 注意事项" href=#注意事项><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><ol><li>注意引入的类名，有很多同名的类，使用 <code>io.micrometer.core</code> 包下的类。</li></ol></article><div class="gdoc-page__footer flex flex-wrap justify-between"></div></div></main><footer class=gdoc-footer><div class="container flex flex-wrap"><span class=gdoc-footer__item>Copyright © 2020-2022 <a href=https://www.nxest.com class=gdoc-footer__link>nxest.com</a>.</span></div></footer></div><script defer src=/bits-pieces/js/en.search.min.js></script>
<script defer src=/bits-pieces/js/clipboard.min.js></script>
<script>document.addEventListener("DOMContentLoaded",function(){var t=new ClipboardJS(".clip")})</script></body></html>